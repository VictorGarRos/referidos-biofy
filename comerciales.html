<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <title>Gestión de Comerciales</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Estilos propios -->
  <link href="style_comerciales.css" rel="stylesheet">
</head>

<body>
  <div class="com-page">

    <!-- TÍTULO PRINCIPAL -->
    <header class="com-header mb-4">
      <h1 class="com-title">Gestión de Comerciales</h1>
      <p class="com-subtitle">
        Crea y edita los comerciales que tendrán acceso al panel de referidos.
      </p>
    </header>

    <!-- CARD FORMULARIO -->
    <section class="card shadow-sm mb-4 com-card">
      <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h2 class="h5 mb-0">Crear / Editar comercial</h2>
            <small class="text-muted">Define los datos básicos y las credenciales de acceso.</small>
          </div>
          <span id="estadoEdicionCom" class="badge rounded-pill bg-warning-subtle text-warning-emphasis d-none">
            Editando comercial...
          </span>
        </div>

        <form id="comercialForm" class="row g-3">

          <div class="col-xl-4 col-lg-6">
            <label class="form-label fw-semibold">Nombre</label>
            <input type="text" id="nombreCom" class="form-control" placeholder="Nombre y apellidos" required>
          </div>

          <div class="col-xl-3 col-lg-6">
            <label class="form-label fw-semibold">Teléfono</label>
            <input type="text" id="tfnoCom" class="form-control" placeholder="Ej: 600123123">
          </div>

          <div class="col-xl-5 col-lg-6">
            <label class="form-label fw-semibold">Delegación</label>
            <select id="delegacionCom" class="form-select" required>
              <option value="">Selecciona una delegación...</option>
            </select>
          </div>

          <div class="col-xl-4 col-lg-6">
            <label class="form-label fw-semibold">Email</label>
            <input type="email" id="emailCom" class="form-control" placeholder="comercial@biofy.es" required>
          </div>

          <div class="col-xl-4 col-lg-6">
            <label class="form-label fw-semibold">Contraseña</label>
            <input type="text" id="passwordCom" class="form-control" placeholder="Mínimo 6 caracteres" required>
          </div>

          <div class="col-12 d-flex flex-wrap gap-2 mt-2">
            <button type="submit" id="btnGuardarCom" class="btn btn-primary px-4">
              Guardar comercial
            </button>
            <button type="button" id="btnCancelarEdicionCom" class="btn btn-outline-secondary btn-sm d-none">
              Cancelar edición
            </button>
            <span class="text-muted small">
              Al crear un comercial nuevo se generará también un usuario en Firebase Authentication.
            </span>
          </div>

        </form>
      </div>
    </section>

    <!-- CARD TABLA -->
    <section class="card shadow-sm com-card">
      <div class="card-body">
        <h2 class="h5 mb-3">Listado de comerciales</h2>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Nombre</th>
                <th>Teléfono</th>
                <th>Delegación</th>
                <th>Email</th>
                <th>Contraseña</th>
                <th style="width: 170px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyComerciales"></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- Firebase + lógica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      doc,
      updateDoc,
      deleteDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getAuth,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // === CONFIG FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyDYxWe9Fk5u6iNltfTQKFl9NB1WJFsw2wk",
      authDomain: "referidos-biofy.firebaseapp.com",
      projectId: "referidos-biofy",
      storageBucket: "referidos-biofy.firebasestorage.app",
      messagingSenderId: "976417715238",
      appId: "1:976417715238:web:fd6ccde09546887966e2e7",
      measurementId: "G-PM4H5G51KT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const comercialesRef = collection(db, "comerciales");
    const delegacionesRef = collection(db, "delegaciones");

    // === DOM ===
    const formCom = document.getElementById("comercialForm");
    const nombreComInput = document.getElementById("nombreCom");
    const tfnoComInput = document.getElementById("tfnoCom");
    const delegacionComSel = document.getElementById("delegacionCom");
    const emailComInput = document.getElementById("emailCom");
    const passwordComInput = document.getElementById("passwordCom");

    const tbodyCom = document.getElementById("tbodyComerciales");
    const btnGuardarCom = document.getElementById("btnGuardarCom");
    const btnCancelCom = document.getElementById("btnCancelarEdicionCom");
    const estadoEdicionCom = document.getElementById("estadoEdicionCom");

    let editingComId = null;

    const delegacionesCache = {};
    const comercialesCache = {};

    // ===== CARGAR DELEGACIONES =====
    async function cargarDelegaciones() {
      try {
        const snap = await getDocs(delegacionesRef);
        delegacionComSel.innerHTML = '<option value="">Selecciona una delegación...</option>';

        snap.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          delegacionesCache[id] = data;

          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = data.nombre || "(sin nombre)";
          delegacionComSel.appendChild(opt);
        });
      } catch (err) {
        console.error("Error cargando delegaciones:", err);
      }
    }
    cargarDelegaciones();

    // ===== RESET FORM =====
    function resetFormComercial() {
      formCom.reset();
      editingComId = null;
      btnGuardarCom.textContent = "Guardar comercial";
      btnCancelCom.classList.add("d-none");
      estadoEdicionCom.classList.add("d-none");
    }

    btnCancelCom.addEventListener("click", resetFormComercial);

    // ===== GUARDAR / EDITAR COMERCIAL =====
    formCom.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nombre = nombreComInput.value.trim();
      const tfno = tfnoComInput.value.trim();
      const delegacionId = delegacionComSel.value;
      const email = emailComInput.value.trim();
      const password = passwordComInput.value.trim();

      if (!delegacionId) {
        alert("Selecciona una delegación");
        return;
      }
      if (!email || !password) {
        alert("Email y contraseña son obligatorios");
        return;
      }

      const delegacion = delegacionesCache[delegacionId];
      const delegacionNombre = delegacion?.nombre || "";

      try {
        if (editingComId) {
          // === EDITAR SOLO EN FIRESTORE (NO toca Auth) ===
          await updateDoc(doc(db, "comerciales", editingComId), {
            nombre,
            tfno,
            delegacionId,
            delegacionNombre,
            email,
            password
          });

        } else {
          // === CREAR NUEVO COMERCIAL ===
          let uid = null;

          try {
            const cred = await createUserWithEmailAndPassword(auth, email, password);
            uid = cred.user.uid;
          } catch (errAuth) {
            if (errAuth.code === "auth/email-already-in-use") {
              alert("Ese email ya existía en Firebase Auth. Se recreará solo la ficha de comercial.");
            } else {
              throw errAuth;
            }
          }

          await addDoc(comercialesRef, {
            nombre,
            tfno,
            delegacionId,
            delegacionNombre,
            email,
            password,     // (texto plano – solo para demo, en producción mejor no guardarla)
            uid: uid || null
          });
        }

        resetFormComercial();
      } catch (err) {
        console.error("Error guardando comercial:", err);
        if (err.code === "auth/weak-password") {
          alert("La contraseña es demasiado débil (mínimo 6 caracteres).");
        } else {
          alert("Error guardando comercial. Revisa la consola.");
        }
      }
    });

    // ===== LISTAR COMERCIALES (SE EJECUTA 1 VEZ) =====
    const qCom = query(comercialesRef, orderBy("nombre", "asc"));

    onSnapshot(qCom, (snapshot) => {
      tbodyCom.innerHTML = "";
      Object.keys(comercialesCache).forEach(k => delete comercialesCache[k]);

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        comercialesCache[id] = data;

        const tr = document.createElement("tr");
        tr.dataset.id = id;
        tr.innerHTML = `
          <td>${data.nombre || "-"}</td>
          <td>${data.tfno || "-"}</td>
          <td>${data.delegacionNombre || "-"}</td>
          <td>${data.email || "-"}</td>
          <td>${data.password || ""}</td>
          <td>
            <button class="btn btn-outline-secondary btn-sm btn-edit-com">Editar</button>
            <button class="btn btn-outline-danger btn-sm ms-1 btn-delete-com">Borrar</button>
          </td>
        `;
        tbodyCom.appendChild(tr);
      });
    });

    // ===== ACCIONES EDITAR / BORRAR =====
    tbodyCom.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const fila = btn.closest("tr");
      if (!fila) return;

      const id = fila.dataset.id;
      const data = comercialesCache[id];
      if (!data) return;

      // EDITAR
      if (btn.classList.contains("btn-edit-com")) {
        editingComId = id;

        nombreComInput.value = data.nombre || "";
        tfnoComInput.value = data.tfno || "";
        delegacionComSel.value = data.delegacionId || "";
        emailComInput.value = data.email || "";
        passwordComInput.value = data.password || "";

        btnGuardarCom.textContent = "Guardar cambios";
        btnCancelCom.classList.remove("d-none");
        estadoEdicionCom.classList.remove("d-none");
      }

      // BORRAR
      if (btn.classList.contains("btn-delete-com")) {
        const ok = confirm("¿Seguro que quieres borrar este comercial? (no elimina su usuario en Auth)");
        if (!ok) return;

        try {
          await deleteDoc(doc(db, "comerciales", id));
          if (editingComId === id) resetFormComercial();
        } catch (err) {
          console.error("Error borrando comercial:", err);
          alert("Error borrando comercial. Revisa la consola.");
        }
      }
    });
  </script>
</body>

</html>
